<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:int-hadoop="http://www.springframework.org/schema/integration/hadoop"
	xmlns:hdp="http://www.springframework.org/schema/hadoop"
	xsi:schemaLocation="http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/hadoop http://www.springframework.org/schema/integration/hadoop/spring-integration-hadoop.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/hadoop http://www.springframework.org/schema/hadoop/spring-hadoop.xsd">

	<!-- TODO: should register default scheduler and executor from a namespace parser, this would
	allow to use existing task framework defined by other components. Anyway these will be get from
	a context bean factory -->
	<bean id="taskScheduler" class="org.springframework.scheduling.concurrent.ConcurrentTaskScheduler"/>
	<bean id="taskExecutor" class="org.springframework.core.task.SyncTaskExecutor"/>

	<int:channel id="input"/>

	<int:payload-type-router input-channel="input" default-output-channel="objects">
		<int:mapping type="java.lang.String" channel="files"/>
	</int:payload-type-router>

	<int:object-to-json-transformer input-channel="objects" output-channel="files"/>

	<hdp:configuration register-url-handler="false" properties-location="file:${XD_HOME}/config/hadoop.properties"/>

	<bean id="storageEventPublisher" class="org.springframework.data.hadoop.store.event.DefaultStorageEventPublisher"/>

	<int-hadoop:rollover-policy>
		<int-hadoop:size size="${rolloverSize:1G}" />
	</int-hadoop:rollover-policy>

	<int-hadoop:naming-policy>
		<int-hadoop:static file-name="${fileName:data}" />
		<int-hadoop:rolling />
		<int-hadoop:codec />
		<int-hadoop:renaming configuration="hadoopConfiguration" suffix="${inUseSuffix:.tmp}" prefix="${inUsePrefix:}" />
	</int-hadoop:naming-policy>

	<int-hadoop:storage id="storage"
		base-path="${directory:/xd/${xd.stream.name}}"
		codec="${codec:}"
		rollover-policy="fileRolloverPolicy"
		naming-policy="fileNamingPolicy"/>

	<int-hadoop:writer id="storageWriter"
		base-path="${directory:/xd/${xd.stream.name}}"
		idle-timeout="${idleTimeout:0}"/>

	<int-hadoop:hdfs-outbound-channel-adapter id="files"
		writer="storageWriter"/>

</beans>
